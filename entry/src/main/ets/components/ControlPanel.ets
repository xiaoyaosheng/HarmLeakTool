import { ComponentCounts } from '../models/DataModels';

/**
 * æ§åˆ¶é¢æ¿ç»„ä»¶
 * 
 * æä¾›ç”¨æˆ·äº¤äº’æ§åˆ¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
 * 1. ç»„ä»¶åˆ›å»ºå’Œé”€æ¯æ§åˆ¶
 * 2. è§†å›¾åˆ‡æ¢åŠŸèƒ½
 * 3. å†…å­˜æ¸…ç†å’Œé‡ç½®åŠŸèƒ½
 * 4. æ‰¹é‡æ“ä½œåŠŸèƒ½
 * 
 * æ»¡è¶³éœ€æ±‚: 3.1, 3.2, 3.3
 */
@Component
export struct ControlPanel {
  // å›è°ƒå‡½æ•°æ¥å£
  onCreateComponent?: (type: 'leaky' | 'proper') => void;
  onDestroyComponent?: (type: 'leaky' | 'proper') => void;
  onClearMemory?: () => void;
  onSwitchView?: (view: 'leaky' | 'proper' | 'comparison') => void;
  onBatchOperation?: (operation: 'create' | 'destroy', count: number, type: 'leaky' | 'proper') => void;
  onResetAll?: () => void;

  // å½“å‰çŠ¶æ€
  @Prop currentView: 'leaky' | 'proper' | 'comparison' = 'leaky';
  @Prop componentCounts: ComponentCounts = { leaky: 0, proper: 0 };
  @Prop memoryUsage: number = 0;
  @Prop isOperating: boolean = false;

  // å†…éƒ¨çŠ¶æ€
  @State private batchCount: number = 5;
  @State private selectedBatchType: 'leaky' | 'proper' = 'leaky';
  @State private showBatchControls: boolean = false;

  build() {
    Column({ space: 16 }) {
      // æ ‡é¢˜
      Text('æ§åˆ¶é¢æ¿')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 8 })

      // è§†å›¾åˆ‡æ¢åŒºåŸŸ
      this.buildViewSwitcher()

      // ç»„ä»¶çŠ¶æ€æ˜¾ç¤º
      this.buildStatusDisplay()

      // å•ä¸ªç»„ä»¶æ§åˆ¶åŒºåŸŸ
      this.buildSingleComponentControls()

      // æ‰¹é‡æ“ä½œåŒºåŸŸ
      this.buildBatchControls()

      // å†…å­˜ç®¡ç†åŒºåŸŸ
      this.buildMemoryControls()
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#F8F9FA')
    .borderRadius(12)
    .border({
      width: 1,
      color: '#E0E0E0',
      style: BorderStyle.Solid
    })
  }

  /**
   * æ„å»ºè§†å›¾åˆ‡æ¢å™¨
   * éœ€æ±‚ 3.2: å®ç°è§†å›¾åˆ‡æ¢åŠŸèƒ½
   */
  @Builder
  private buildViewSwitcher() {
    Column({ space: 12 }) {
      Text('è§†å›¾æ¨¡å¼')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#555555')

      Row({ space: 8 }) {
        // æ³„éœ²ç»„ä»¶è§†å›¾
        Button('æ³„éœ²ç»„ä»¶')
          .type(ButtonType.Normal)
          .backgroundColor(this.currentView === 'leaky' ? '#FF6B6B' : '#FFFFFF')
          .fontColor(this.currentView === 'leaky' ? '#FFFFFF' : '#FF6B6B')
          .border({
            width: 1,
            color: '#FF6B6B',
            style: BorderStyle.Solid
          })
          .borderRadius(6)
          .fontSize(12)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onClick(() => {
            if (this.onSwitchView) {
              this.onSwitchView('leaky');
            }
          })

        // æ­£ç¡®ç»„ä»¶è§†å›¾
        Button('æ­£ç¡®ç»„ä»¶')
          .type(ButtonType.Normal)
          .backgroundColor(this.currentView === 'proper' ? '#4CAF50' : '#FFFFFF')
          .fontColor(this.currentView === 'proper' ? '#FFFFFF' : '#4CAF50')
          .border({
            width: 1,
            color: '#4CAF50',
            style: BorderStyle.Solid
          })
          .borderRadius(6)
          .fontSize(12)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onClick(() => {
            if (this.onSwitchView) {
              this.onSwitchView('proper');
            }
          })

        // å¯¹æ¯”è§†å›¾
        Button('å¯¹æ¯”è§†å›¾')
          .type(ButtonType.Normal)
          .backgroundColor(this.currentView === 'comparison' ? '#2196F3' : '#FFFFFF')
          .fontColor(this.currentView === 'comparison' ? '#FFFFFF' : '#2196F3')
          .border({
            width: 1,
            color: '#2196F3',
            style: BorderStyle.Solid
          })
          .borderRadius(6)
          .fontSize(12)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onClick(() => {
            if (this.onSwitchView) {
              this.onSwitchView('comparison');
            }
          })
      }
      .justifyContent(FlexAlign.SpaceEvenly)
      .width('100%')
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
  }

  /**
   * æ„å»ºçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
   */
  @Builder
  private buildStatusDisplay() {
    Column({ space: 8 }) {
      Text('ç»„ä»¶çŠ¶æ€')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#555555')

      Row({ space: 16 }) {
        // æ³„éœ²ç»„ä»¶æ•°é‡
        Column({ space: 4 }) {
          Text('æ³„éœ²ç»„ä»¶')
            .fontSize(12)
            .fontColor('#FF6B6B')
          Text(`${this.componentCounts.leaky}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')
        }

        // æ­£ç¡®ç»„ä»¶æ•°é‡
        Column({ space: 4 }) {
          Text('æ­£ç¡®ç»„ä»¶')
            .fontSize(12)
            .fontColor('#4CAF50')
          Text(`${this.componentCounts.proper}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4CAF50')
        }

        // å†…å­˜ä½¿ç”¨é‡
        Column({ space: 4 }) {
          Text('å†…å­˜ä½¿ç”¨')
            .fontSize(12)
            .fontColor('#FF9800')
          Text(`${this.memoryUsage.toFixed(1)} MB`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9800')
        }
      }
      .justifyContent(FlexAlign.SpaceEvenly)
      .width('100%')
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
  }

  /**
   * æ„å»ºå•ä¸ªç»„ä»¶æ§åˆ¶åŒºåŸŸ
   * éœ€æ±‚ 3.1: åˆ›å»ºç»„ä»¶åˆ›å»ºå’Œé”€æ¯çš„æ§åˆ¶æŒ‰é’®
   */
  @Builder
  private buildSingleComponentControls() {
    Column({ space: 12 }) {
      Text('å•ä¸ªç»„ä»¶æ§åˆ¶')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#555555')

      // æ³„éœ²ç»„ä»¶æ§åˆ¶
      Row({ space: 8 }) {
        Text('æ³„éœ²ç»„ä»¶:')
          .fontSize(14)
          .fontColor('#FF6B6B')
          .width(80)

        Button('åˆ›å»º')
          .type(ButtonType.Normal)
          .backgroundColor('#FF6B6B')
          .fontColor('#FFFFFF')
          .borderRadius(6)
          .fontSize(12)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .enabled(!this.isOperating)
          .onClick(() => {
            if (this.onCreateComponent) {
              this.onCreateComponent('leaky');
            }
          })

        Button('é”€æ¯')
          .type(ButtonType.Normal)
          .backgroundColor('#FFFFFF')
          .fontColor('#FF6B6B')
          .border({
            width: 1,
            color: '#FF6B6B',
            style: BorderStyle.Solid
          })
          .borderRadius(6)
          .fontSize(12)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .enabled(!this.isOperating && this.componentCounts.leaky > 0)
          .onClick(() => {
            if (this.onDestroyComponent) {
              this.onDestroyComponent('leaky');
            }
          })
      }
      .alignItems(VerticalAlign.Center)
      .width('100%')

      // æ­£ç¡®ç»„ä»¶æ§åˆ¶
      Row({ space: 8 }) {
        Text('æ­£ç¡®ç»„ä»¶:')
          .fontSize(14)
          .fontColor('#4CAF50')
          .width(80)

        Button('åˆ›å»º')
          .type(ButtonType.Normal)
          .backgroundColor('#4CAF50')
          .fontColor('#FFFFFF')
          .borderRadius(6)
          .fontSize(12)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .enabled(!this.isOperating)
          .onClick(() => {
            if (this.onCreateComponent) {
              this.onCreateComponent('proper');
            }
          })

        Button('é”€æ¯')
          .type(ButtonType.Normal)
          .backgroundColor('#FFFFFF')
          .fontColor('#4CAF50')
          .border({
            width: 1,
            color: '#4CAF50',
            style: BorderStyle.Solid
          })
          .borderRadius(6)
          .fontSize(12)
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .enabled(!this.isOperating && this.componentCounts.proper > 0)
          .onClick(() => {
            if (this.onDestroyComponent) {
              this.onDestroyComponent('proper');
            }
          })
      }
      .alignItems(VerticalAlign.Center)
      .width('100%')
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
  }

  /**
   * æ„å»ºæ‰¹é‡æ“ä½œæ§åˆ¶åŒºåŸŸ
   * éœ€æ±‚ 3.3: å®ç°æ‰¹é‡æ“ä½œåŠŸèƒ½ä»¥å¿«é€Ÿè§¦å‘å†…å­˜æ³„éœ²
   */
  @Builder
  private buildBatchControls() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('æ‰¹é‡æ“ä½œ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#555555')

        Button(this.showBatchControls ? 'æ”¶èµ·' : 'å±•å¼€')
          .type(ButtonType.Normal)
          .backgroundColor('#FFFFFF')
          .fontColor('#2196F3')
          .border({
            width: 1,
            color: '#2196F3',
            style: BorderStyle.Solid
          })
          .borderRadius(4)
          .fontSize(10)
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .onClick(() => {
            this.showBatchControls = !this.showBatchControls;
          })
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .width('100%')

      if (this.showBatchControls) {
        Column({ space: 12 }) {
          // æ‰¹é‡æ“ä½œé…ç½®
          Row({ space: 12 }) {
            Text('æ•°é‡:')
              .fontSize(14)
              .fontColor('#666666')

            Button('-')
              .type(ButtonType.Circle)
              .backgroundColor('#E0E0E0')
              .fontColor('#666666')
              .width(32)
              .height(32)
              .fontSize(16)
              .enabled(this.batchCount > 1)
              .onClick(() => {
                if (this.batchCount > 1) {
                  this.batchCount--;
                }
              })

            Text(`${this.batchCount}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .width(40)
              .textAlign(TextAlign.Center)

            Button('+')
              .type(ButtonType.Circle)
              .backgroundColor('#E0E0E0')
              .fontColor('#666666')
              .width(32)
              .height(32)
              .fontSize(16)
              .enabled(this.batchCount < 20)
              .onClick(() => {
                if (this.batchCount < 20) {
                  this.batchCount++;
                }
              })
          }
          .alignItems(VerticalAlign.Center)

          // ç»„ä»¶ç±»å‹é€‰æ‹©
          Row({ space: 8 }) {
            Text('ç±»å‹:')
              .fontSize(14)
              .fontColor('#666666')

            Button('æ³„éœ²ç»„ä»¶')
              .type(ButtonType.Normal)
              .backgroundColor(this.selectedBatchType === 'leaky' ? '#FF6B6B' : '#FFFFFF')
              .fontColor(this.selectedBatchType === 'leaky' ? '#FFFFFF' : '#FF6B6B')
              .border({
                width: 1,
                color: '#FF6B6B',
                style: BorderStyle.Solid
              })
              .borderRadius(4)
              .fontSize(12)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .onClick(() => {
                this.selectedBatchType = 'leaky';
              })

            Button('æ­£ç¡®ç»„ä»¶')
              .type(ButtonType.Normal)
              .backgroundColor(this.selectedBatchType === 'proper' ? '#4CAF50' : '#FFFFFF')
              .fontColor(this.selectedBatchType === 'proper' ? '#FFFFFF' : '#4CAF50')
              .border({
                width: 1,
                color: '#4CAF50',
                style: BorderStyle.Solid
              })
              .borderRadius(4)
              .fontSize(12)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .onClick(() => {
                this.selectedBatchType = 'proper';
              })
          }
          .alignItems(VerticalAlign.Center)

          // æ‰¹é‡æ“ä½œæŒ‰é’®
          Row({ space: 12 }) {
            Button(`æ‰¹é‡åˆ›å»º ${this.batchCount} ä¸ª`)
              .type(ButtonType.Normal)
              .backgroundColor(this.selectedBatchType === 'leaky' ? '#FF6B6B' : '#4CAF50')
              .fontColor('#FFFFFF')
              .borderRadius(6)
              .fontSize(12)
              .layoutWeight(1)
              .enabled(!this.isOperating)
              .onClick(() => {
                if (this.onBatchOperation) {
                  this.onBatchOperation('create', this.batchCount, this.selectedBatchType);
                }
              })

            Button(`æ‰¹é‡é”€æ¯ ${this.batchCount} ä¸ª`)
              .type(ButtonType.Normal)
              .backgroundColor('#FFFFFF')
              .fontColor(this.selectedBatchType === 'leaky' ? '#FF6B6B' : '#4CAF50')
              .border({
                width: 1,
                color: this.selectedBatchType === 'leaky' ? '#FF6B6B' : '#4CAF50',
                style: BorderStyle.Solid
              })
              .borderRadius(6)
              .fontSize(12)
              .layoutWeight(1)
              .enabled(!this.isOperating && 
                ((this.selectedBatchType === 'leaky' && this.componentCounts.leaky >= this.batchCount) ||
                 (this.selectedBatchType === 'proper' && this.componentCounts.proper >= this.batchCount)))
              .onClick(() => {
                if (this.onBatchOperation) {
                  this.onBatchOperation('destroy', this.batchCount, this.selectedBatchType);
                }
              })
          }
          .width('100%')

          // å¿«é€Ÿè§¦å‘å†…å­˜æ³„éœ²æŒ‰é’®
          Button('ğŸš€ å¿«é€Ÿè§¦å‘å†…å­˜æ³„éœ² (åˆ›å»º10ä¸ªæ³„éœ²ç»„ä»¶)')
            .type(ButtonType.Normal)
            .backgroundColor('#FF4444')
            .fontColor('#FFFFFF')
            .borderRadius(6)
            .fontSize(12)
            .width('100%')
            .enabled(!this.isOperating)
            .onClick(() => {
              if (this.onBatchOperation) {
                this.onBatchOperation('create', 10, 'leaky');
              }
            })
        }
        .width('100%')
      }
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
  }

  /**
   * æ„å»ºå†…å­˜ç®¡ç†æ§åˆ¶åŒºåŸŸ
   * éœ€æ±‚ 3.2: æ·»åŠ å†…å­˜æ¸…ç†å’Œé‡ç½®åŠŸèƒ½
   */
  @Builder
  private buildMemoryControls() {
    Column({ space: 12 }) {
      Text('å†…å­˜ç®¡ç†')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#555555')

      Row({ space: 8 }) {
        // å†…å­˜æ¸…ç†æŒ‰é’®
        Button('æ¸…ç†å†…å­˜')
          .type(ButtonType.Normal)
          .backgroundColor('#FF9800')
          .fontColor('#FFFFFF')
          .borderRadius(6)
          .fontSize(12)
          .layoutWeight(1)
          .enabled(!this.isOperating)
          .onClick(() => {
            if (this.onClearMemory) {
              this.onClearMemory();
            }
          })

        // é‡ç½®æ‰€æœ‰æŒ‰é’®
        Button('é‡ç½®æ‰€æœ‰')
          .type(ButtonType.Normal)
          .backgroundColor('#F44336')
          .fontColor('#FFFFFF')
          .borderRadius(6)
          .fontSize(12)
          .layoutWeight(1)
          .enabled(!this.isOperating)
          .onClick(() => {
            if (this.onResetAll) {
              this.onResetAll();
            }
          })
      }
      .width('100%')

      // æ“ä½œæç¤º
      if (this.isOperating) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(16)
            .height(16)
            .color('#2196F3')

          Text('æ“ä½œè¿›è¡Œä¸­...')
            .fontSize(12)
            .fontColor('#2196F3')
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .margin({ top: 8 })
      }

      // ä½¿ç”¨è¯´æ˜
      Column({ space: 4 }) {
        Text('ä½¿ç”¨è¯´æ˜:')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor('#666666')

        Text('â€¢ åˆ›å»ºæ³„éœ²ç»„ä»¶åä¸é”€æ¯å¯è§‚å¯Ÿå†…å­˜æ³„éœ²')
          .fontSize(10)
          .fontColor('#999999')

        Text('â€¢ ä½¿ç”¨æ‰¹é‡æ“ä½œå¯å¿«é€Ÿè§¦å‘å¤§é‡å†…å­˜æ³„éœ²')
          .fontSize(10)
          .fontColor('#999999')

        Text('â€¢ å¯¹æ¯”è§†å›¾å¯åŒæ—¶è§‚å¯Ÿä¸¤ç§ç»„ä»¶çš„å·®å¼‚')
          .fontSize(10)
          .fontColor('#999999')

        Text('â€¢ æ¸…ç†å†…å­˜å¯æ¨¡æ‹Ÿåƒåœ¾å›æ”¶æ•ˆæœ')
          .fontSize(10)
          .fontColor('#999999')
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
      .padding({ top: 8 })
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
  }
}