import { LeakyComponent } from '../components/LeakyComponent';
import { ControlPanel } from '../components/ControlPanel';
import { ComponentInstance, MemoryStats, ComponentCounts } from '../models/DataModels';
import { MemoryUtils } from '../utils/MemoryUtils';
import router from '@ohos.router';

/**
 * ÂÜÖÂ≠òÊ≥ÑÈú≤ÊºîÁ§∫‰∏ªÈ°µÈù¢
 *
 * ËøôÊòØÂÜÖÂ≠òÊ≥ÑÈú≤ÊºîÁ§∫ÂäüËÉΩÁöÑ‰∏ªÂÆπÂô®ÁªÑ‰ª∂ÔºåË¥üË¥£Ôºö
 * 1. Êï¥ÂêàÊâÄÊúâÂ≠êÁªÑ‰ª∂ (LeakyComponent, ProperComponent, MemoryMonitor, ControlPanel)
 * 2. ÁÆ°ÁêÜÁªÑ‰ª∂ÂÆû‰æãÁöÑÂä®ÊÄÅÂàõÂª∫ÂíåÈîÄÊØÅ
 * 3. ÂçèË∞ÉÂêÑÁªÑ‰ª∂Èó¥ÁöÑÁä∂ÊÄÅÂíå‰∫§‰∫í
 * 4. Êèê‰æõÈ°µÈù¢ÂØºËà™ÂíåÂ∏ÉÂ±ÄÁÆ°ÁêÜ
 *
 * Êª°Ë∂≥ÈúÄÊ±Ç: 2.1, 3.1, 3.2
 */
@Entry
@Component
struct MemoryLeakDemo {
  // ÂΩìÂâçËßÜÂõæÊ®°Âºè
  @State private currentView: 'leaky' | 'proper' | 'comparison' = 'leaky';

  // ÁªÑ‰ª∂ÂÆû‰æãÁÆ°ÁêÜ
  @State private leakyComponents: ComponentInstance[] = [];
  @State private properComponents: ComponentInstance[] = [];
  @State private componentIdCounter: number = 0;

  // ÂÜÖÂ≠òÁªüËÆ°
  @State private memoryStats: MemoryStats = {
    totalAllocated: 0,
    currentUsage: 0,
    leakedMemory: 0,
    componentCount: 0
  };

  // Êìç‰ΩúÁä∂ÊÄÅ
  @State private isOperating: boolean = false;
  @State private operationMessage: string = '';

  // È°µÈù¢Áä∂ÊÄÅ
  @State private pageTitle: string = 'È∏øËíôÂÜÖÂ≠òÊ≥ÑÈú≤Ê®°Êãü';
  @State private showInstructions: boolean = true;

  /**
   * È°µÈù¢Âç≥Â∞ÜÂá∫Áé∞Êó∂ÁöÑÁîüÂëΩÂë®ÊúüÊñπÊ≥ï
   */
  aboutToAppear() {
    console.info('[MemoryLeakDemo] È°µÈù¢ÂºÄÂßãÂä†ËΩΩ');
    this.initializePage();
  }

  /**
   * È°µÈù¢Âç≥Â∞ÜÊ∂àÂ§±Êó∂ÁöÑÁîüÂëΩÂë®ÊúüÊñπÊ≥ï
   * Á°Æ‰øùÊ∏ÖÁêÜÊâÄÊúâËµÑÊ∫ê
   */
  aboutToDisappear() {
    console.info('[MemoryLeakDemo] È°µÈù¢ÂºÄÂßãÈîÄÊØÅÔºåÊ∏ÖÁêÜÊâÄÊúâËµÑÊ∫ê');
    this.resetAllComponents();
  }

  /**
   * ÂàùÂßãÂåñÈ°µÈù¢
   */
  private initializePage(): void {
    // ÈáçÁΩÆÁªüËÆ°‰ø°ÊÅØ
    this.updateMemoryStats();
    console.info('[MemoryLeakDemo] È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
  }

  /**
   * ÂàõÂª∫ÁªÑ‰ª∂ÂÆû‰æã
   * ÈúÄÊ±Ç 3.1: ÂÆûÁé∞ÁªÑ‰ª∂ÂàõÂª∫ÂäüËÉΩ
   */
  private createComponent = (type: 'leaky' | 'proper'): void => {
    if (this.isOperating) {
      return;
    }

    this.setOperating(true, `Ê≠£Âú®ÂàõÂª∫${type === 'leaky' ? 'Ê≥ÑÈú≤' : 'Ê≠£Á°Æ'}ÁªÑ‰ª∂...`);

    try {
      const componentId = `${type}_${++this.componentIdCounter}_${Date.now()}`;
      const memorySize = this.calculateComponentMemorySize(type);

      const newComponent: ComponentInstance = {
        id: componentId,
        type: type,
        createdAt: Date.now(),
        memorySize: memorySize,
        isDestroyed: false
      };

      if (type === 'leaky') {
        this.leakyComponents.push(newComponent);
        console.info(`[MemoryLeakDemo] ÂàõÂª∫Ê≥ÑÈú≤ÁªÑ‰ª∂: ${componentId}`);
      } else {
        this.properComponents.push(newComponent);
        console.info(`[MemoryLeakDemo] ÂàõÂª∫Ê≠£Á°ÆÁªÑ‰ª∂: ${componentId}`);
      }

      // Êõ¥Êñ∞ÂÜÖÂ≠òÁªüËÆ°
      this.updateMemoryStats();

      setTimeout(() => {
        this.setOperating(false, '');
      }, 500);

    } catch (error) {
      console.error('[MemoryLeakDemo] ÂàõÂª∫ÁªÑ‰ª∂Â§±Ë¥•:', error);
      this.setOperating(false, '');
    }
  };

  /**
   * ÈîÄÊØÅÁªÑ‰ª∂ÂÆû‰æã
   * ÈúÄÊ±Ç 3.1: ÂÆûÁé∞ÁªÑ‰ª∂ÈîÄÊØÅÂäüËÉΩ
   */
  private destroyComponent = (type: 'leaky' | 'proper'): void => {
    if (this.isOperating) {
      return;
    }

    const components = type === 'leaky' ? this.leakyComponents : this.properComponents;
    if (components.length === 0) {
      return;
    }

    this.setOperating(true, `Ê≠£Âú®ÈîÄÊØÅ${type === 'leaky' ? 'Ê≥ÑÈú≤' : 'Ê≠£Á°Æ'}ÁªÑ‰ª∂...`);

    try {
      // ÊâæÂà∞ÊúÄÂêé‰∏Ä‰∏™Êú™ÈîÄÊØÅÁöÑÁªÑ‰ª∂
      const componentToDestroy = components.find(comp => !comp.isDestroyed);

      if (componentToDestroy) {
        componentToDestroy.isDestroyed = true;
        console.info(`[MemoryLeakDemo] ÈîÄÊØÅÁªÑ‰ª∂: ${componentToDestroy.id}`);

        // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ÁªÑ‰ª∂
        if (type === 'leaky') {
          this.leakyComponents = this.leakyComponents.filter(comp => comp.id !== componentToDestroy.id);
        } else {
          this.properComponents = this.properComponents.filter(comp => comp.id !== componentToDestroy.id);
        }

        // Êõ¥Êñ∞ÂÜÖÂ≠òÁªüËÆ°
        this.updateMemoryStats();
      }

      setTimeout(() => {
        this.setOperating(false, '');
      }, 300);

    } catch (error) {
      console.error('[MemoryLeakDemo] ÈîÄÊØÅÁªÑ‰ª∂Â§±Ë¥•:', error);
      this.setOperating(false, '');
    }
  };

  /**
   * ÊâπÈáèÊìç‰ΩúÁªÑ‰ª∂
   * ÈúÄÊ±Ç 3.3: ÂÆûÁé∞ÊâπÈáèÊìç‰ΩúÂäüËÉΩ
   */
  private batchOperation = (operation: 'create' | 'destroy', count: number, type: 'leaky' | 'proper'): void => {
    if (this.isOperating) {
      return;
    }

    const operationName = operation === 'create' ? 'ÂàõÂª∫' : 'ÈîÄÊØÅ';
    const componentName = type === 'leaky' ? 'Ê≥ÑÈú≤' : 'Ê≠£Á°Æ';

    this.setOperating(true, `Ê≠£Âú®ÊâπÈáè${operationName} ${count} ‰∏™${componentName}ÁªÑ‰ª∂...`);

    // ‰ΩøÁî®ÂºÇÊ≠•Êìç‰ΩúÊù•ÈÅøÂÖçÈòªÂ°ûUI
    setTimeout(() => {
      try {
        for (let i = 0; i < count; i++) {
          if (operation === 'create') {
            this.createComponentSync(type);
          } else {
            this.destroyComponentSync(type);
          }
        }

        this.updateMemoryStats();
        console.info(`[MemoryLeakDemo] ÊâπÈáè${operationName}ÂÆåÊàê: ${count} ‰∏™${componentName}ÁªÑ‰ª∂`);

      } catch (error) {
        console.error(`[MemoryLeakDemo] ÊâπÈáè${operationName}Â§±Ë¥•:`, error);
      } finally {
        this.setOperating(false, '');
      }
    }, 100);
  };

  /**
   * ÂêåÊ≠•ÂàõÂª∫ÁªÑ‰ª∂ÔºàÁî®‰∫éÊâπÈáèÊìç‰ΩúÔºâ
   */
  private createComponentSync(type: 'leaky' | 'proper'): void {
    const componentId = `${type}_${++this.componentIdCounter}_${Date.now()}`;
    const memorySize = this.calculateComponentMemorySize(type);

    const newComponent: ComponentInstance = {
      id: componentId,
      type: type,
      createdAt: Date.now(),
      memorySize: memorySize,
      isDestroyed: false
    };

    if (type === 'leaky') {
      this.leakyComponents.push(newComponent);
    } else {
      this.properComponents.push(newComponent);
    }
  }

  /**
   * ÂêåÊ≠•ÈîÄÊØÅÁªÑ‰ª∂ÔºàÁî®‰∫éÊâπÈáèÊìç‰ΩúÔºâ
   */
  private destroyComponentSync(type: 'leaky' | 'proper'): void {
    const components = type === 'leaky' ? this.leakyComponents : this.properComponents;
    const componentToDestroy = components.find(comp => !comp.isDestroyed);

    if (componentToDestroy) {
      if (type === 'leaky') {
        this.leakyComponents = this.leakyComponents.filter(comp => comp.id !== componentToDestroy.id);
      } else {
        this.properComponents = this.properComponents.filter(comp => comp.id !== componentToDestroy.id);
      }
    }
  }

  /**
   * ÂàáÊç¢ËßÜÂõæÊ®°Âºè
   * ÈúÄÊ±Ç 3.2: ÂÆûÁé∞ËßÜÂõæÂàáÊç¢ÂäüËÉΩ
   */
  private switchView = (view: 'leaky' | 'proper' | 'comparison'): void => {
    if (this.currentView !== view) {
      this.currentView = view;
      console.info(`[MemoryLeakDemo] ÂàáÊç¢Âà∞ËßÜÂõæ: ${view}`);
    }
  };

  /**
   * Ê∏ÖÁêÜÂÜÖÂ≠ò
   * ÈúÄÊ±Ç 3.2: ÂÆûÁé∞ÂÜÖÂ≠òÊ∏ÖÁêÜÂäüËÉΩ
   */
  private clearMemory = (): void => {
    if (this.isOperating) {
      return;
    }

    this.setOperating(true, 'Ê≠£Âú®Ê∏ÖÁêÜÂÜÖÂ≠ò...');

    setTimeout(() => {
      try {
        // Ê®°ÊãüÂÜÖÂ≠òÊ∏ÖÁêÜÔºöÈáçÊñ∞ËÆ°ÁÆóÂÜÖÂ≠òÁªüËÆ°
        this.updateMemoryStats();
        console.info('[MemoryLeakDemo] ÂÜÖÂ≠òÊ∏ÖÁêÜÂÆåÊàê');

      } catch (error) {
        console.error('[MemoryLeakDemo] ÂÜÖÂ≠òÊ∏ÖÁêÜÂ§±Ë¥•:', error);
      } finally {
        this.setOperating(false, '');
      }
    }, 1000);
  };

  /**
   * ÈáçÁΩÆÊâÄÊúâÁªÑ‰ª∂
   * ÈúÄÊ±Ç 3.2: ÂÆûÁé∞ÈáçÁΩÆÂäüËÉΩ
   */
  private resetAllComponents = (): void => {
    if (this.isOperating) {
      return;
    }

    this.setOperating(true, 'Ê≠£Âú®ÈáçÁΩÆÊâÄÊúâÁªÑ‰ª∂...');

    setTimeout(() => {
      try {
        // Ê∏ÖÁ©∫ÊâÄÊúâÁªÑ‰ª∂
        this.leakyComponents = [];
        this.properComponents = [];
        this.componentIdCounter = 0;

        // ÈáçÁΩÆÂÜÖÂ≠òÁªüËÆ°
        this.updateMemoryStats();

        console.info('[MemoryLeakDemo] ÈáçÁΩÆÂÆåÊàê');

      } catch (error) {
        console.error('[MemoryLeakDemo] ÈáçÁΩÆÂ§±Ë¥•:', error);
      } finally {
        this.setOperating(false, '');
      }
    }, 800);
  };

  /**
   * Êõ¥Êñ∞ÂÜÖÂ≠òÁªüËÆ°‰ø°ÊÅØ
   */
  private updateMemoryStats(): void {
    const leakyMemory = this.leakyComponents.reduce((total, comp) => total + comp.memorySize, 0);
    const properMemory = this.properComponents.reduce((total, comp) => total + comp.memorySize, 0);

    this.memoryStats = {
      totalAllocated: leakyMemory + properMemory,
      currentUsage: properMemory, // Ê≠£Á°ÆÁªÑ‰ª∂ÁöÑÂÜÖÂ≠ò‰ºöË¢´Ê≠£Á°ÆÈáäÊîæ
      leakedMemory: leakyMemory,  // Ê≥ÑÈú≤ÁªÑ‰ª∂ÁöÑÂÜÖÂ≠ò‰∏ç‰ºöË¢´ÈáäÊîæ
      componentCount: this.leakyComponents.length + this.properComponents.length
    };
  }

  /**
   * ËÆ°ÁÆóÁªÑ‰ª∂ÂÜÖÂ≠òÂ§ßÂ∞è
   */
  private calculateComponentMemorySize(type: 'leaky' | 'proper'): number {
    // ÊØè‰∏™Ê≥ÑÈú≤ÁªÑ‰ª∂Á∫¶Âç†Áî®10MBÂÜÖÂ≠òÔºà5‰∏™2MBÁöÑÊï∞ÊçÆÂØπË±°Ôºâ
    // Ê≠£Á°ÆÁªÑ‰ª∂Âú®ÈîÄÊØÅÊó∂‰ºöÈáäÊîæÂÜÖÂ≠ò
    return type === 'leaky' ? 10 : 10;
  }

  /**
   * ËÆæÁΩÆÊìç‰ΩúÁä∂ÊÄÅ
   */
  private setOperating(operating: boolean, message: string): void {
    this.isOperating = operating;
    this.operationMessage = message;
  }

  /**
   * ËøîÂõû‰∏ªÈ°µ
   */
  private goBack = (): void => {
    router.back();
  };

  /**
   * ÊûÑÂª∫È°µÈù¢UI
   */
  build() {
    Column({ space: 0 }) {
      // È°µÈù¢Ê†áÈ¢òÊ†è
      this.buildTitleBar()

      // È°µÈù¢ÂÜÖÂÆπ
      Scroll() {
        Column({ space: 16 }) {
          // ‰ΩøÁî®ËØ¥Êòé
          if (this.showInstructions) {
            this.buildInstructions()
          }

          // ÊéßÂà∂Èù¢Êùø
          ControlPanel({
            currentView: this.currentView,
            componentCounts: {
              leaky: this.leakyComponents.length,
              proper: this.properComponents.length
            } as ComponentCounts,
            memoryUsage: this.memoryStats.totalAllocated,
            isOperating: this.isOperating,
            onCreateComponent: this.createComponent,
            onDestroyComponent: this.destroyComponent,
            onClearMemory: this.clearMemory,
            onSwitchView: this.switchView,
            onBatchOperation: this.batchOperation,
            onResetAll: this.resetAllComponents
          })

          // ÂÜÖÂ≠òÁõëÊéßÈù¢ÊùøÔºà‰∏¥Êó∂ÂÆûÁé∞ÔºåÁ≠âÂæÖMemoryMonitorÁªÑ‰ª∂Ôºâ
          this.buildMemoryMonitorPlaceholder()

          // ÁªÑ‰ª∂Â±ïÁ§∫Âå∫Âüü
          this.buildComponentDisplay()
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  /**
   * ÊûÑÂª∫Ê†áÈ¢òÊ†è
   */
  @Builder
  private buildTitleBar() {
    Row({ space: 12 }) {
      // ËøîÂõûÊåâÈíÆ
      Button('‚Üê ËøîÂõû')
        .type(ButtonType.Normal)
        .backgroundColor('#FFFFFF')
        .fontColor('#2196F3')
        .border({
          width: 1,
          color: '#2196F3',
          style: BorderStyle.Solid
        })
        .borderRadius(6)
        .fontSize(14)
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .onClick(this.goBack)

      // È°µÈù¢Ê†áÈ¢ò
      Text(this.pageTitle)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // ËØ¥ÊòéÂºÄÂÖ≥
      Button(this.showInstructions ? 'ÈöêËóèËØ¥Êòé' : 'ÊòæÁ§∫ËØ¥Êòé')
        .type(ButtonType.Normal)
        .backgroundColor('#FFFFFF')
        .fontColor('#666666')
        .border({
          width: 1,
          color: '#E0E0E0',
          style: BorderStyle.Solid
        })
        .borderRadius(6)
        .fontSize(12)
        .padding({ left: 8, right: 8, top: 6, bottom: 6 })
        .onClick(() => {
          this.showInstructions = !this.showInstructions;
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .border({
      width: { bottom: 1 },
      color: '#E0E0E0',
      style: BorderStyle.Solid
    })
  }

  /**
   * ÊûÑÂª∫‰ΩøÁî®ËØ¥Êòé
   */
  @Builder
  private buildInstructions() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('üìñ')
          .fontSize(18)
        Text('‰ΩøÁî®ËØ¥Êòé')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .alignItems(VerticalAlign.Center)

      Column({ space: 8 }) {
        Text('1. ‰ΩøÁî®ÊéßÂà∂Èù¢ÊùøÂàõÂª∫ÂíåÈîÄÊØÅÁªÑ‰ª∂ÔºåËßÇÂØüÂÜÖÂ≠ò‰ΩøÁî®ÂèòÂåñ')
          .fontSize(12)
          .fontColor('#666666')
          .textAlign(TextAlign.Start)
          .width('100%')

        Text('2. Ê≥ÑÈú≤ÁªÑ‰ª∂Âú®ÈîÄÊØÅÂêé‰∏ç‰ºöÈáäÊîæÂÜÖÂ≠òÔºåÊ≠£Á°ÆÁªÑ‰ª∂‰ºöÊ≠£Á°ÆÊ∏ÖÁêÜ')
          .fontSize(12)
          .fontColor('#666666')
          .textAlign(TextAlign.Start)
          .width('100%')

        Text('3. ‰ΩøÁî®ÊâπÈáèÊìç‰ΩúÂèØ‰ª•Âø´ÈÄüÂàõÂª∫Â§ö‰∏™ÁªÑ‰ª∂ËßÇÂØüÂÜÖÂ≠òÊ≥ÑÈú≤ÊïàÊûú')
          .fontSize(12)
          .fontColor('#666666')
          .textAlign(TextAlign.Start)
          .width('100%')

        Text('4. ÂàáÊç¢‰∏çÂêåËßÜÂõæÊ®°ÂºèÂèØ‰ª•ÂØπÊØî‰∏§ÁßçÁªÑ‰ª∂ÁöÑÂÆûÁé∞Â∑ÆÂºÇ')
          .fontSize(12)
          .fontColor('#666666')
          .textAlign(TextAlign.Start)
          .width('100%')
      }
      .alignItems(HorizontalAlign.Start)
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#E3F2FD')
    .borderRadius(8)
    .border({
      width: 1,
      color: '#2196F3',
      style: BorderStyle.Solid
    })
  }

  /**
   * ÊûÑÂª∫ÂÜÖÂ≠òÁõëÊéßÂç†‰ΩçÁ¨¶ÔºàÁ≠âÂæÖMemoryMonitorÁªÑ‰ª∂ÂÆûÁé∞Ôºâ
   */
  @Builder
  private buildMemoryMonitorPlaceholder() {
    Column({ space: 12 }) {
      Text('üìä ÂÜÖÂ≠òÁõëÊéß')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')

      Row({ space: 16 }) {
        // ÊÄªÂÜÖÂ≠ò
        Column({ space: 4 }) {
          Text('ÊÄªÂàÜÈÖç')
            .fontSize(12)
            .fontColor('#666666')
          Text(`${this.memoryStats.totalAllocated.toFixed(1)} MB`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2196F3')
        }

        // ÂΩìÂâç‰ΩøÁî®
        Column({ space: 4 }) {
          Text('ÂΩìÂâç‰ΩøÁî®')
            .fontSize(12)
            .fontColor('#666666')
          Text(`${this.memoryStats.currentUsage.toFixed(1)} MB`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4CAF50')
        }

        // Ê≥ÑÈú≤ÂÜÖÂ≠ò
        Column({ space: 4 }) {
          Text('Ê≥ÑÈú≤ÂÜÖÂ≠ò')
            .fontSize(12)
            .fontColor('#666666')
          Text(`${this.memoryStats.leakedMemory.toFixed(1)} MB`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')
        }

        // ÁªÑ‰ª∂Êï∞Èáè
        Column({ space: 4 }) {
          Text('ÁªÑ‰ª∂Êï∞Èáè')
            .fontSize(12)
            .fontColor('#666666')
          Text(`${this.memoryStats.componentCount}`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9800')
        }
      }
      .justifyContent(FlexAlign.SpaceEvenly)
      .width('100%')

      // Êìç‰ΩúÁä∂ÊÄÅÊòæÁ§∫
      if (this.isOperating && this.operationMessage) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(16)
            .height(16)
            .color('#2196F3')
          Text(this.operationMessage)
            .fontSize(12)
            .fontColor('#2196F3')
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .margin({ top: 8 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .border({
      width: 1,
      color: '#E0E0E0',
      style: BorderStyle.Solid
    })
  }

  /**
   * ÊûÑÂª∫ÁªÑ‰ª∂Â±ïÁ§∫Âå∫Âüü
   * ÈúÄÊ±Ç 2.1: ÂêåÊó∂Â±ïÁ§∫ÊúâÈóÆÈ¢òÁöÑÁªÑ‰ª∂ÂíåÊ≠£Á°ÆÂÆûÁé∞ÁöÑÁªÑ‰ª∂
   */
  @Builder
  private buildComponentDisplay() {
    Column({ space: 16 }) {
      Text('üß© ÁªÑ‰ª∂Â±ïÁ§∫Âå∫Âüü')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)

      if (this.currentView === 'leaky') {
        // Âè™ÊòæÁ§∫Ê≥ÑÈú≤ÁªÑ‰ª∂
        this.buildLeakyComponentsView()
      } else if (this.currentView === 'proper') {
        // Âè™ÊòæÁ§∫Ê≠£Á°ÆÁªÑ‰ª∂ÔºàÂç†‰ΩçÁ¨¶Ôºâ
        this.buildProperComponentsView()
      } else if (this.currentView === 'comparison') {
        // ÂØπÊØîËßÜÂõæ
        this.buildComparisonView()
      }
    }
    .width('100%')
  }

  /**
   * ÊûÑÂª∫Ê≥ÑÈú≤ÁªÑ‰ª∂ËßÜÂõæ
   */
  @Builder
  private buildLeakyComponentsView() {
    Column({ space: 12 }) {
      Text(`Ê≥ÑÈú≤ÁªÑ‰ª∂ (${this.leakyComponents.length} ‰∏™)`)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FF6B6B')
        .alignSelf(ItemAlign.Start)

      if (this.leakyComponents.length === 0) {
        Text('ÊöÇÊó†Ê≥ÑÈú≤ÁªÑ‰ª∂ÔºåËØ∑‰ΩøÁî®ÊéßÂà∂Èù¢ÊùøÂàõÂª∫')
          .fontSize(12)
          .fontColor('#999999')
          .textAlign(TextAlign.Center)
          .width('100%')
          .padding(32)
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
      } else {
        // ÊòæÁ§∫Ââç3‰∏™Ê≥ÑÈú≤ÁªÑ‰ª∂‰Ωú‰∏∫Á§∫‰æã
        ForEach(this.leakyComponents.slice(0, 3), (component: ComponentInstance) => {
          LeakyComponent()
            .margin({ bottom: 8 })
        })

        if (this.leakyComponents.length > 3) {
          Text(`... ËøòÊúâ ${this.leakyComponents.length - 3} ‰∏™Ê≥ÑÈú≤ÁªÑ‰ª∂`)
            .fontSize(12)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
            .width('100%')
            .padding(16)
            .backgroundColor('#F9F9F9')
            .borderRadius(8)
        }
      }
    }
    .width('100%')
  }

  /**
   * ÊûÑÂª∫Ê≠£Á°ÆÁªÑ‰ª∂ËßÜÂõæÔºàÂç†‰ΩçÁ¨¶Ôºâ
   */
  @Builder
  private buildProperComponentsView() {
    Column({ space: 12 }) {
      Text(`Ê≠£Á°ÆÁªÑ‰ª∂ (${this.properComponents.length} ‰∏™)`)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#4CAF50')
        .alignSelf(ItemAlign.Start)

      // Âç†‰ΩçÁ¨¶ÔºåÁ≠âÂæÖProperComponentÁªÑ‰ª∂ÂÆûÁé∞
      Column({ space: 8 }) {
        Text('üöß Ê≠£Á°ÆÁªÑ‰ª∂ÂºÄÂèë‰∏≠')
          .fontSize(16)
          .fontColor('#FF9800')
        Text('ProperComponent ÁªÑ‰ª∂Â∞öÊú™ÂÆûÁé∞')
          .fontSize(12)
          .fontColor('#666666')
        Text('ËØ∑ÂÖàÂÆåÊàê‰ªªÂä°3ÁöÑÂÆûÁé∞')
          .fontSize(12)
          .fontColor('#666666')
      }
      .width('100%')
      .padding(32)
      .backgroundColor('#FFF3E0')
      .borderRadius(8)
      .border({
        width: 1,
        color: '#FF9800',
        style: BorderStyle.Dashed
      })
    }
    .width('100%')
  }

  /**
   * ÊûÑÂª∫ÂØπÊØîËßÜÂõæ
   */
  @Builder
  private buildComparisonView() {
    Row({ space: 16 }) {
      // Â∑¶‰æßÔºöÊ≥ÑÈú≤ÁªÑ‰ª∂
      Column({ space: 12 }) {
        Text('‚ùå Ê≥ÑÈú≤ÁªÑ‰ª∂')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FF6B6B')

        if (this.leakyComponents.length > 0) {
          LeakyComponent()
        } else {
          Text('ÊöÇÊó†Ê≥ÑÈú≤ÁªÑ‰ª∂')
            .fontSize(12)
            .fontColor('#999999')
            .padding(16)
            .backgroundColor('#FFF5F5')
            .borderRadius(8)
        }
      }
      .layoutWeight(1)

      // Âè≥‰æßÔºöÊ≠£Á°ÆÁªÑ‰ª∂ÔºàÂç†‰ΩçÁ¨¶Ôºâ
      Column({ space: 12 }) {
        Text('‚úÖ Ê≠£Á°ÆÁªÑ‰ª∂')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#4CAF50')

        // Âç†‰ΩçÁ¨¶
        Column({ space: 4 }) {
          Text('üöß ÂºÄÂèë‰∏≠')
            .fontSize(12)
            .fontColor('#FF9800')
          Text('ProperComponent')
            .fontSize(10)
            .fontColor('#666666')
          Text('Â∞öÊú™ÂÆûÁé∞')
            .fontSize(10)
            .fontColor('#666666')
        }
        .padding(16)
        .backgroundColor('#FFF3E0')
        .borderRadius(8)
        .border({
          width: 1,
          color: '#FF9800',
          style: BorderStyle.Dashed
        })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
  }
}